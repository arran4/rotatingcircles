name: Fix and Format

on:
  push:
    branches-ignore:
      - 'main'
      - 'fixed-*'
      - 'gh-readonly-queue/**' # safety

permissions:
  contents: write
  pull-requests: write

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Run go fix and fmt
        run: |
          go fix ./...
          go fmt ./...
          # Placeholder for lexer generation
          echo "No lexer generation configured."

      - name: Check for changes
        id: git_diff
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Push changes and create PR
        if: steps.git_diff.outputs.changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          FIX_BRANCH="fixed-$BRANCH_NAME"
          ACTOR=${{ github.actor }}

          echo "Detected changes. Creating/Updating fix branch: $FIX_BRANCH"

          # Check if fix branch exists remote
          git fetch origin $FIX_BRANCH || true

          # Checkout new branch
          git checkout -b $FIX_BRANCH

          git add .
          git commit -m "chore: go fix and fmt"

          # Force push
          git push -f origin $FIX_BRANCH

          # Handle PR creation
          PR_EXISTS=$(gh pr list --head $FIX_BRANCH --base $BRANCH_NAME --json number --jq '.[0].number')

          if [ -z "$PR_EXISTS" ]; then
            echo "Creating new PR..."
            PR_URL=$(gh pr create --title "Auto-fix: $BRANCH_NAME" --body "Automated fixes (go fix, go fmt) for @$ACTOR." --head $FIX_BRANCH --base $BRANCH_NAME)
            echo "PR created: $PR_URL"
          else
            echo "PR already exists: #$PR_EXISTS"
            gh pr comment $PR_EXISTS --body "Updated fixes have been pushed."
            PR_URL=$(gh pr view $PR_EXISTS --json url --jq '.url')
          fi

          # Notify on the Original PR (if this branch is a PR to somewhere else)
          ORIGINAL_PR=$(gh pr list --head $BRANCH_NAME --json number --jq '.[0].number')

          if [ -n "$ORIGINAL_PR" ]; then
             echo "Found original PR #$ORIGINAL_PR"
             gh pr comment $ORIGINAL_PR --body "ðŸ‘‹ @$ACTOR, I found some issues that could be fixed automatically. I've created a fix PR for you: $PR_URL"
          fi
